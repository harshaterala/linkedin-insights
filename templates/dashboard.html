{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1><i class="bi bi-graph-up"></i> LinkedIn Insights Dashboard</h1>
        <p class="text-muted">Analyze LinkedIn company pages with powerful insights</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card text-center">
            <h3><i class="bi bi-building text-primary"></i> {{ pages_count }}</h3>
            <p class="text-muted">Pages Tracked</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card text-center">
            <h3><i class="bi bi-people-fill text-success"></i> {{ total_followers|default(0) }}</h3>
            <p class="text-muted">Total Followers</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card text-center">
            <h3><i class="bi bi-postcard text-warning"></i> {{ posts_count|default(0) }}</h3>
            <p class="text-muted">Total Posts</p>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card text-center">
            <h3><i class="bi bi-person-badge text-info"></i> {{ employees_count|default(0) }}</h3>
            <p class="text-muted">Employees</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-search"></i> Search & Analyze Pages</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" id="pageIdInput" class="form-control" placeholder="Enter LinkedIn Page ID (e.g., deepsolv)">
                    <button class="btn btn-primary" onclick="analyzePage()">
                        <i class="bi bi-search"></i> Analyze
                    </button>
                </div>
                
                <div id="results" class="mt-3"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/docs" class="btn btn-outline-primary">
                        <i class="bi bi-code-slash"></i> API Documentation
                    </a>
                    <a href="/redoc" class="btn btn-outline-success">
                        <i class="bi bi-file-text"></i> ReDoc Docs
                    </a>
                    <button class="btn btn-outline-info" onclick="loadSampleData()">
                        <i class="bi bi-database"></i> View Sample Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-table"></i> Recent Pages</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Page</th>
                                <th>Industry</th>
                                <th>Followers</th>
                                <th>Employees</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pagesTable">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function analyzePage() {
    const pageId = document.getElementById('pageIdInput').value;
    if (!pageId) return;
    
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '<div class="alert alert-info">Analyzing page... <div class="spinner-border spinner-border-sm ms-2"></div></div>';
    
    try {
        const response = await fetch(`/api/v1/pages/${pageId}`);
        const data = await response.json();
        
        resultsDiv.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <img src="${data.profile_picture_url || 'https://via.placeholder.com/150'}" 
                                 class="page-avatar" alt="${data.name}">
                        </div>
                        <div class="col-md-9">
                            <h4>${data.name}</h4>
                            <p><i class="bi bi-link"></i> <a href="${data.url}" target="_blank">${data.url}</a></p>
                            <p><i class="bi bi-people-fill"></i> <strong>${data.total_followers.toLocaleString()}</strong> followers</p>
                            <p><i class="bi bi-building"></i> ${data.industry || 'Not specified'}</p>
                            <p><i class="bi bi-geo-alt"></i> ${data.location || 'Location not available'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        loadPagesTable(); // Refresh the table
    } catch (error) {
        resultsDiv.innerHTML = '<div class="alert alert-danger">Error analyzing page. Please check the page ID.</div>';
    }
}

async function loadPagesTable() {
    try {
        const response = await fetch('/api/v1/pages/?size=5');
        const data = await response.json();
        
        const tableBody = document.getElementById('pagesTable');
        tableBody.innerHTML = data.items.map(page => `
            <tr>
                <td>
                    <strong>${page.name}</strong><br>
                    <small class="text-muted">${page.page_id}</small>
                </td>
                <td>${page.industry || '-'}</td>
                <td><span class="badge bg-primary">${page.total_followers.toLocaleString()}</span></td>
                <td>${page.head_count ? page.head_count.toLocaleString() : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewPage('${page.page_id}')">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading pages:', error);
    }
}

function viewPage(pageId) {
    document.getElementById('pageIdInput').value = pageId;
    analyzePage();
}

function loadSampleData() {
    // Pre-populate with sample page IDs
    const samples = ['deepsolv', 'microsoft', 'google', 'apple', 'meta'];
    const randomSample = samples[Math.floor(Math.random() * samples.length)];
    document.getElementById('pageIdInput').value = randomSample;
    analyzePage();
}

// Load initial data
loadPagesTable();
</script>
{% endblock %}
